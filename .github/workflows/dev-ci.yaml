name: Build & Deploy to Dev (GitOps)

on:
  push:
    branches: [ "main" ]
    paths:
      - "api-gateway/**"
      - "users-service/**"
      - "orders-service/**"
      - "reports-service/**"
      - ".github/workflows/dev-ci.yaml"

concurrency:
  group: dev-gitops-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write      # push to GitOps repo
  id-token: write      # future OIDC use

env:
  ENV: dev
  REGISTRY: docker.io
  IMAGE_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}

  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  GITOPS_REPO: ${{ secrets.GITOPS_REPO }}     # org/app-services-gitops
  GITOPS_BRANCH: main
  GITOPS_PAT: ${{ secrets.GITOPS_PAT }}

jobs:
  build-and-update-dev:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout app monorepo
      # ---------------------------
      - name: Checkout app repo
        uses: actions/checkout@v4

      # ---------------------------
      # Detect changed services
      # ---------------------------
      - name: Detect changed services
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api-gateway:
              - 'api-gateway/**'
            users-service:
              - 'users-service/**'
            orders-service:
              - 'orders-service/**'
            reports-service:
              - 'reports-service/**'

      - name: Print changed services
        run: |
          echo "api-gateway:     ${{ steps.changes.outputs.api-gateway }}"
          echo "users-service:   ${{ steps.changes.outputs.users-service }}"
          echo "orders-service:  ${{ steps.changes.outputs.orders-service }}"
          echo "reports-service: ${{ steps.changes.outputs.reports-service }}"

      # ---------------------------
      # Docker login
      # ---------------------------
      - name: Login to Docker Hub
        run: |
          echo "${DOCKERHUB_TOKEN}" | docker login ${REGISTRY} \
            -u "${DOCKERHUB_USERNAME}" --password-stdin

      # =========================================================
      # BUILD & PUSH — api-gateway
      # =========================================================
      - name: Build & push api-gateway
        id: build_api_gateway
        if: steps.changes.outputs.api-gateway == 'true'
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(jq -r .version api-gateway/package.json)
          TAG="${VERSION}-${GITHUB_SHA::7}"
          IMAGE="${REGISTRY}/${IMAGE_NAMESPACE}/api-gateway"

          echo "Building ${IMAGE}:${TAG}"
          docker build -t "${IMAGE}:${TAG}" api-gateway
          docker push "${IMAGE}:${TAG}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      # =========================================================
      # BUILD & PUSH — users-service
      # =========================================================
      - name: Build & push users-service
        id: build_users_service
        if: steps.changes.outputs.users-service == 'true'
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(jq -r .version users-service/package.json)
          TAG="${VERSION}-${GITHUB_SHA::7}"
          IMAGE="${REGISTRY}/${IMAGE_NAMESPACE}/users-service"

          echo "Building ${IMAGE}:${TAG}"
          docker build -t "${IMAGE}:${TAG}" users-service
          docker push "${IMAGE}:${TAG}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      # =========================================================
      # BUILD & PUSH — orders-service (placeholder ready)
      # =========================================================
      - name: Build & push orders-service
        id: build_orders_service
        if: steps.changes.outputs.orders-service == 'true'
        shell: bash
        run: |
          set -euo pipefail

          TAG="0.1.0-${GITHUB_SHA::7}"
          IMAGE="${REGISTRY}/${IMAGE_NAMESPACE}/orders-service"

          docker build -t "${IMAGE}:${TAG}" orders-service
          docker push "${IMAGE}:${TAG}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      # =========================================================
      # BUILD & PUSH — reports-service (placeholder ready)
      # =========================================================
      - name: Build & push reports-service
        id: build_reports_service
        if: steps.changes.outputs.reports-service == 'true'
        shell: bash
        run: |
          set -euo pipefail

          TAG="0.1.0-${GITHUB_SHA::7}"
          IMAGE="${REGISTRY}/${IMAGE_NAMESPACE}/reports-service"

          docker build -t "${IMAGE}:${TAG}" reports-service
          docker push "${IMAGE}:${TAG}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      # ---------------------------
      # Checkout GitOps repo
      # ---------------------------
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          ref: ${{ env.GITOPS_BRANCH }}
          token: ${{ env.GITOPS_PAT }}
          path: gitops

      # ---------------------------
      # Install yq
      # ---------------------------
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      # ---------------------------
      # Update GitOps (Dev)
      # ---------------------------
      - name: Update dev kustomization
        working-directory: gitops
        shell: bash
        run: |
          set -euo pipefail
          KUSTOMIZATION="k8s/overlays/dev/kustomization.yaml"

          if [[ "${{ steps.changes.outputs.api-gateway }}" == "true" ]]; then
            yq e -i '
              (.images[] | select(.name == "api-gateway").newTag)
              = "${{ steps.build_api_gateway.outputs.tag }}"
            ' "$KUSTOMIZATION"
          fi

          if [[ "${{ steps.changes.outputs.users-service }}" == "true" ]]; then
            yq e -i '
              (.images[] | select(.name == "users-service").newTag)
              = "${{ steps.build_users_service.outputs.tag }}"
            ' "$KUSTOMIZATION"
          fi

          if [[ "${{ steps.changes.outputs.orders-service }}" == "true" ]]; then
            yq e -i '
              (.images[] | select(.name == "orders-service").newTag)
              = "${{ steps.build_orders_service.outputs.tag }}"
            ' "$KUSTOMIZATION"
          fi

          if [[ "${{ steps.changes.outputs.reports-service }}" == "true" ]]; then
            yq e -i '
              (.images[] | select(.name == "reports-service").newTag)
              = "${{ steps.build_reports_service.outputs.tag }}"
            ' "$KUSTOMIZATION"
          fi

      # ---------------------------
      # Commit & push GitOps changes
      # ---------------------------
      - name: Commit & push GitOps changes
        working-directory: gitops
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No GitOps changes to commit."
            exit 0
          fi

          git add k8s/overlays/dev/kustomization.yaml
          git commit -m "chore(dev): deploy ${GITHUB_SHA::7}"
          git push origin "${GITOPS_BRANCH}"
