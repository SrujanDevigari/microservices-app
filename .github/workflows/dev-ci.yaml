name: Build & Deploy to Dev (GitOps)

on:
  push:
    branches: [ "main" ]
    paths:
      - "api-gateway/**"
      - "users-service/**"
      - ".github/workflows/**"

jobs:
  build-and-update-gitops:
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      GITOPS_REPO: ${{ secrets.GITOPS_REPO }} # e.g. https://github.com/youruser/app-services-gitops.git

    steps:
      # 1) Checkout this app repo
      - name: Checkout app repo
        uses: actions/checkout@v4

      # 2) Detect which services changed
      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            users:
              - 'users-service/**'
            gateway:
              - 'api-gateway/**'

      - name: Show change detection
        run: |
          echo "users-service changed?  ${{ steps.changes.outputs.users }}"
          echo "api-gateway changed?   ${{ steps.changes.outputs.gateway }}"

      # 3) Set up Docker & login (common)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4) Build & push users-service only if it changed
      - name: Build & push users-service image
        if: steps.changes.outputs.users == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./users-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/users-service:${{ github.sha }}

      # 5) Build & push api-gateway only if it changed
      - name: Build & push api-gateway image
        if: steps.changes.outputs.gateway == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./api-gateway
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:${{ github.sha }}

      # 6) Skip GitOps update if nothing relevant changed
      - name: Skip if no relevant changes
        if: steps.changes.outputs.users != 'true' && steps.changes.outputs.gateway != 'true'
        run: |
          echo "No users-service or api-gateway changes. Skipping GitOps update."
          exit 0

      # 7) Clone GitOps repo & update dev tags (only runs if at least one service changed)
      - name: Clone GitOps repo and update dev tags
        if: steps.changes.outputs.users == 'true' || steps.changes.outputs.gateway == 'true'
        run: |
          git clone https://${{ secrets.GITOPS_PAT }}@${GITOPS_REPO#https://} gitops
          cd gitops
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Before change:"
          cat k8s/overlays/dev/kustomization.yaml

#  We will still use the same tag (commit SHA) for both images
          # Kustomize file has:
          # images:
            # - name: youruser/users-service
              # newTag: someTag
            # - name: youruser/api-gateway
              # newTag: someTag
          
          # This command updates ALL 'newTag:' lines in that file:
          sed -i "s/newTag: .*/newTag: ${GITHUB_SHA}/" k8s/overlays/dev/kustomization.yaml

          echo "After change:"
          cat k8s/overlays/dev/kustomization.yaml

          if ! git diff --quiet; then
            git commit -am "Update dev images to ${GITHUB_SHA}"
            git push
          else
            echo "No changes to commit in GitOps repo."
          fi
