name: Build & Deploy to Dev (GitOps)

on:
  push:
    branches: ["main"]
    paths:
      - "api-gateway/**"
      - "users-service/**"
      - ".github/workflows/**"

jobs:
  build-and-update-gitops:
    runs-on: ubuntu-latest

    env:
      # Set repo-level env defaults from secrets
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
      GITOPS_PAT: ${{ secrets.GITOPS_PAT }}

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            users:
              - 'users-service/**'
            gateway:
              - 'api-gateway/**'

      - name: Show change detection
        run: |
          echo "users-service changed?  ${{ steps.changes.outputs.users }}"
          echo "api-gateway changed?   ${{ steps.changes.outputs.gateway }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push users-service image
        if: steps.changes.outputs.users == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./users-service
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/users-service:${{ github.sha }}

      - name: Build & push api-gateway image
        if: steps.changes.outputs.gateway == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./api-gateway
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:${{ github.sha }}

      - name: Skip if no relevant changes
        if: steps.changes.outputs.users != 'true' && steps.changes.outputs.gateway != 'true'
        run: |
          echo "No users-service or api-gateway changes. Skipping GitOps update."
          exit 0

      - name: Clone GitOps repo and update dev tags
        if: steps.changes.outputs.users == 'true' || steps.changes.outputs.gateway == 'true'
        run: |
          # Make a safe clone of GitOps repo using PAT
          # Expect secrets.GITOPS_REPO to be like: https://github.com/youruser/app-services-gitops.git
          echo "Cloning GitOps repo..."
          repo_url="${GITOPS_REPO}"
          # remove protocol prefix if present (safe handling)
          repo_host="${repo_url#https://}"
          git clone "https://${GITOPS_PAT}@${repo_host}" gitops
          cd gitops

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Before change:"
          cat k8s/overlays/dev/kustomization.yaml || true

          # Update all newTag lines to the current commit SHA
          # This is a simple, pragmatic sed replace of 'newTag: <whatever>' lines.
          sed -i "s/^\\([[:space:]]*newTag:[[:space:]]*\\).*$/\\1${GITHUB_SHA}/" k8s/overlays/dev/kustomization.yaml

          echo "After change:"
          cat k8s/overlays/dev/kustomization.yaml || true

          if ! git diff --quiet; then
            git add k8s/overlays/dev/kustomization.yaml
            git commit -m "ci: update dev images to ${GITHUB_SHA}"
            git push origin HEAD:main
          else
            echo "No changes to commit in GitOps repo."
          fi
